<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    .player-bar {
      position: sticky;
      bottom: 0;
      z-index: 1030;
      background: #fff;
      border-top: 1px solid #ddd;
    }

    audio {
      width: 100%;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">

  <div class="player-bar shadow-sm rounded p-3">

    <!-- Audio -->
    <audio id="player" controls playsinline class="mb-2">
      <source id="audioSource"
              src="https://raw.githubusercontent.com/gre785/audiobook/main/bbsl/1.mp3"
              type="audio/mpeg">
    </audio>

    <!-- Track label -->
    <div class="text-center large text-muted mb-2" id="trackLabel">
      1.mp3
    </div>

    <!-- Controls -->
    <div class="row g-2 align-items-center">

      <div class="col-6 col-md-2 d-grid">
        <button class="btn btn-outline-secondary btn-lg" onclick="playPrev()">
          ◀
        </button>
      </div>

      <div class="col-6 col-md-2 d-grid">
        <button class="btn btn-outline-secondary btn-lg" onclick="playNext()">
          ▶
        </button>
      </div>

      <div class="col-8 col-md-4">
        <input
          type="number"
          id="jumpInput"
          class="form-control form-control-lg"
          min="1"
          max="766"
          placeholder="Jump to (1–766)"
          inputmode="numeric"
        >
      </div>

      <div class="col-4 col-md-2 d-grid">
        <button class="btn btn-primary btn-lg" onclick="jumpTo()">
          Go
        </button>

      </div>

      <div class="col-12 col-md-2 d-grid">
        <button
          id="autoplayToggle"
          class="btn btn-outline-success btn-lg"
          onclick="toggleAutoplay()">
          Auto Next: ON
        </button>
      </div>

    </div>
  </div>
</div>

</body>
</html>



<script>
  const START = 1;
  const END = 766;
  const START_AT_SECONDS = 40;
  const STORAGE_KEY_TRACK = "audiobook_last_track";
  const STORAGE_KEY_TIME  = "audiobook_last_time";

  const baseUrl = "https://raw.githubusercontent.com/gre785/audiobook/main/bbsl/";
  const player = document.getElementById("player");
  const source = document.getElementById("audioSource");
  const label = document.getElementById("trackLabel");
  const jumpInput = document.getElementById("jumpInput");

  // Load last saved state
  let index = parseInt(localStorage.getItem(STORAGE_KEY_TRACK), 10) || START;
  let savedTime = parseFloat(localStorage.getItem(STORAGE_KEY_TIME)) || 0;
  const STORAGE_KEY_AUTOPLAY = "audiobook_autoplay_next";

  // default = ON
  let autoplayNext =
    localStorage.getItem(STORAGE_KEY_AUTOPLAY) !== "false";

  const autoplayBtn = document.getElementById("autoplayToggle");

  function updateAutoplayButton() {
    autoplayBtn.textContent = `Auto Next: ${autoplayNext ? "ON" : "OFF"}`;
    autoplayBtn.className =
      "btn btn-lg " +
      (autoplayNext ? "btn-outline-success" : "btn-outline-secondary");
  }

  function toggleAutoplay() {
    autoplayNext = !autoplayNext;
    localStorage.setItem(STORAGE_KEY_AUTOPLAY, autoplayNext);
    updateAutoplayButton();
  }

  function loadTrack(i, time = 0) {
    index = i;
    source.src = baseUrl + index + ".mp3";
    label.textContent = index + ".mp3";
    player.load();
    player.volume = 0.25;
    player.preload = "auto";

    // Restore playback position once metadata is loaded
    player.onloadedmetadata = () => {
      if (time <= 40) {
        player.currentTime = Math.min(START_AT_SECONDS, player.duration || 0);
      }
      if (time > 0 && time < player.duration) {
        player.currentTime = time;
      }
    };
  }

  function playPrev() {
    if (index > START) {
      loadTrack(index - 1);
      player.play();
    }
  }

  function playNext() {
    if (index < END) {
      loadTrack(index + 1);
      player.play();
    }
  }

  function jumpTo() {
    const value = parseInt(jumpInput.value, 10);
    if (value >= START && value <= END) {
      loadTrack(value);
      player.play();
    } else {
      alert("Please enter a number between 1 and 766");
    }
  }

  // Save progress periodically
  player.addEventListener("timeupdate", () => {
    localStorage.setItem(STORAGE_KEY_TRACK, index);
    localStorage.setItem(STORAGE_KEY_TIME, player.currentTime);
  });

  // Auto-play next track when one ends
  player.addEventListener("ended", () => {
    localStorage.setItem(STORAGE_KEY_TIME, 0);

    if (!autoplayNext) return;

    if (index < END) {
      loadTrack(index + 1);
      player.play().catch(() => {
        console.log("Autoplay blocked, user interaction required");
      });
    }
  });

  player.addEventListener("volumechange", () => {
    localStorage.setItem("volume", player.volume);
  });
  // Initial load (resume last session)
  loadTrack(index, savedTime);
</script>
